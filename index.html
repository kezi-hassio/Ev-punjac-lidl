<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#10b981">
  <meta name="description" content="EV Punjaƒç Lidl Kaluƒëerica">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>EV Punjaƒç Lidl</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRVYgUHVuasSDxIcgTGlkbCBLYWx1xJFlcmljYSIsInNob3J0X25hbWUiOiJFViBQdW5qxIHEhyIsImRlc2NyaXB0aW9uIjoiUHJvdmVyaSBzdGF0dXMgaSByZXplcnZpxaFpIHB1bmrEhcSHIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJ0aGVtZV9jb2xvciI6IiMxMGI5ODEiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0IiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCclM0UlM0N0ZXh0IHk9Jy45ZW0nIGZvbnQtc2l6ZT0nOTAnJTNF4pqhJTNDL3RleHQlM0UlM0Mvc3ZnJTNFIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifSx7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCclM0UlM0N0ZXh0IHk9Jy45ZW0nIGZvbnQtc2l6ZT0nOTAnJTNF4pqhJTNDL3RleHQlM0UlM0Mvc3ZnJTNFIiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    @keyframes bounce {
      0%, 100% { transform: translateY(-25%); }
      50% { transform: translateY(0); }
    }
    .animate-bounce { animation: bounce 1s infinite; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const { Battery, Clock, MapPin, User, AlertCircle, Bell } = lucide;

    const EVChargerApp = () => {
      const [chargers, setChargers] = useState([]);
      const [selectedCharger, setSelectedCharger] = useState(null);
      const [showCheckIn, setShowCheckIn] = useState(false);
      const [userName, setUserName] = useState('');
      const [duration, setDuration] = useState(30);
      const [currentUserId, setCurrentUserId] = useState(null);
      const [selectedAvatar, setSelectedAvatar] = useState(null);
      const [notification, setNotification] = useState(null);
      const [lastSessionCheck, setLastSessionCheck] = useState(null);
      const [avatarPreview, setAvatarPreview] = useState(null);
      const [showChat, setShowChat] = useState(false);
      const [messages, setMessages] = useState([]);
      const [newMessage, setNewMessage] = useState('');
      const [currentUserName, setCurrentUserName] = useState('');

      useEffect(() => {
        const savedUserId = localStorage.getItem('currentUserId');
        const savedUserName = localStorage.getItem('currentUserName');
        const savedUserAvatar = localStorage.getItem('currentUserAvatar');
        
        if (savedUserId) setCurrentUserId(savedUserId);
        if (savedUserName) setCurrentUserName(savedUserName);
        if (savedUserAvatar) setAvatarPreview(savedUserAvatar);

        const loadData = async () => {
          try {
            const result = await window.storage.get('chargers', true);
            if (result && result.value) {
              setChargers(JSON.parse(result.value));
            } else {
              const initialChargers = [
                { id: 1, name: 'EV Punjaƒç Lidl Kaluƒëerica', location: 'Kaluƒëerica, Beograd', power: '20kW', type: 'DC' },
              ];
              await window.storage.set('chargers', JSON.stringify(initialChargers), true);
              setChargers(initialChargers);
            }

            const sessionsResult = await window.storage.get('sessions', true);
            if (!sessionsResult) {
              await window.storage.set('sessions', JSON.stringify([]), true);
            } else {
              setLastSessionCheck(JSON.stringify(JSON.parse(sessionsResult.value)));
            }

            const messagesResult = await window.storage.get('chat_messages', true);
            if (!messagesResult) {
              await window.storage.set('chat_messages', JSON.stringify([]), true);
              setMessages([]);
            } else {
              setMessages(JSON.parse(messagesResult.value));
            }
          } catch (error) {
            console.log('Gre≈°ka:', error);
            setChargers([
              { id: 1, name: 'EV Punjaƒç Lidl Kaluƒëerica', location: 'Kaluƒëerica, Beograd', power: '20kW', type: 'DC' },
            ]);
          }
        };
        loadData();

        const interval = setInterval(() => {
          updateSessions();
          checkForNotifications();
          loadMessages();
        }, 5000);

        return () => clearInterval(interval);
      }, []);

      const checkForNotifications = async () => {
        try {
          const result = await window.storage.get('sessions', true);
          if (result && result.value) {
            const currentSessions = JSON.parse(result.value);
            const currentSessionsStr = JSON.stringify(currentSessions);
            
            if (lastSessionCheck && lastSessionCheck !== currentSessionsStr) {
              const oldSessions = JSON.parse(lastSessionCheck);
              
              const newCheckIn = currentSessions.find(s => 
                !oldSessions.some(os => os.id === s.id) && s.userId !== currentUserId
              );
              
              if (newCheckIn) {
                showNotification(`${newCheckIn.userName} je zauzeo punjaƒç!`, 'occupied');
              }
              
              const checkOut = oldSessions.find(s => 
                !currentSessions.some(cs => cs.id === s.id) && s.userId !== currentUserId
              );
              
              if (checkOut) {
                showNotification(`Punjaƒç je sada slobodan!`, 'free');
              }
            }
            
            setLastSessionCheck(currentSessionsStr);
          }
        } catch (error) {
          console.log('Gre≈°ka:', error);
        }
      };

      const showNotification = (message, type) => {
        setNotification({ message, type });
        setTimeout(() => setNotification(null), 5000);
      };

      const updateSessions = async () => {
        try {
          const result = await window.storage.get('sessions', true);
          if (result && result.value) {
            const sessions = JSON.parse(result.value);
            const now = Date.now();
            const activeSessions = sessions.filter(s => s.endTime > now);
            
            if (activeSessions.length !== sessions.length) {
              await window.storage.set('sessions', JSON.stringify(activeSessions), true);
            }
          }
        } catch (error) {
          console.log('Gre≈°ka:', error);
        }
      };

      const getActiveSession = async (chargerId) => {
        try {
          const result = await window.storage.get('sessions', true);
          if (result && result.value) {
            const sessions = JSON.parse(result.value);
            const now = Date.now();
            return sessions.find(s => s.chargerId === chargerId && s.endTime > now);
          }
        } catch (error) {
          console.log('Gre≈°ka:', error);
        }
        return null;
      };

      const loadMessages = async () => {
        try {
          const result = await window.storage.get('chat_messages', true);
          if (result && result.value) {
            setMessages(JSON.parse(result.value));
          }
        } catch (error) {
          console.log('Gre≈°ka:', error);
        }
      };

      const sendMessage = async () => {
        if (!newMessage.trim()) return;
        
        if (!currentUserName) {
          alert('Molim te prvo se check-in-uj na punjaƒç!');
          return;
        }

        const message = {
          id: 'msg_' + Date.now(),
          userId: currentUserId,
          userName: currentUserName,
          avatar: avatarPreview,
          text: newMessage.trim(),
          timestamp: Date.now()
        };

        try {
          const result = await window.storage.get('chat_messages', true);
          const messages = result && result.value ? JSON.parse(result.value) : [];
          messages.push(message);
          
          const recentMessages = messages.slice(-50);
          await window.storage.set('chat_messages', JSON.stringify(recentMessages), true);
          
          setMessages(recentMessages);
          setNewMessage('');
        } catch (error) {
          console.error('Gre≈°ka:', error);
          alert('Gre≈°ka pri slanju poruke.');
        }
      };

      const handleAvatarUpload = (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const MAX_SIZE = 100;
              let width = img.width;
              let height = img.height;

              if (width > height) {
                if (width > MAX_SIZE) {
                  height *= MAX_SIZE / width;
                  width = MAX_SIZE;
                }
              } else {
                if (height > MAX_SIZE) {
                  width *= MAX_SIZE / height;
                  height = MAX_SIZE;
                }
              }

              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);

              const base64String = canvas.toDataURL('image/jpeg', 0.6);
              setSelectedAvatar(base64String);
              setAvatarPreview(base64String);
            };
            img.src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      };

      const handleCheckIn = async () => {
        if (!userName.trim()) {
          alert('Molim te unesi ime!');
          return;
        }
        
        if (!selectedAvatar) {
          alert('Molim te izaberi sliku!');
          return;
        }

        try {
          const now = Date.now();
          const endTime = now + (duration * 60 * 1000);
          const userId = 'user_' + now + '_' + Math.random();

          const newSession = {
            id: 'session_' + now,
            chargerId: selectedCharger.id,
            userName: userName.trim(),
            userId: userId,
            avatar: selectedAvatar,
            startTime: now,
            endTime: endTime,
            duration: duration
          };

          const result = await window.storage.get('sessions', true);
          const sessions = result && result.value ? JSON.parse(result.value) : [];
          
          const filteredSessions = sessions.filter(s => s.chargerId !== selectedCharger.id || s.endTime <= now);
          filteredSessions.push(newSession);
          
          const saveResult = await window.storage.set('sessions', JSON.stringify(filteredSessions), true);
          
          if (!saveResult) {
            throw new Error('Failed to save');
          }
          
          localStorage.setItem('currentUserId', userId);
          localStorage.setItem('currentUserName', userName.trim());
          localStorage.setItem('currentUserAvatar', selectedAvatar);
          
          setCurrentUserId(userId);
          setCurrentUserName(userName.trim());
          
          setShowCheckIn(false);
          setUserName('');
          setDuration(30);
          setSelectedAvatar(null);
          setAvatarPreview(null);
          
          setTimeout(() => {
            window.location.reload();
          }, 500);
        } catch (error) {
          console.error('Gre≈°ka:', error);
          alert('Gre≈°ka pri ƒçekiranju: ' + error.message);
        }
      };

      const handleCheckOut = async (session) => {
        if (!confirm('Da li si siguran?')) {
          return;
        }
        
        try {
          const result = await window.storage.get('sessions', true);
          if (result && result.value) {
            const sessions = JSON.parse(result.value);
            const filteredSessions = sessions.filter(s => s.id !== session.id);
            await window.storage.set('sessions', JSON.stringify(filteredSessions), true);
            
            localStorage.removeItem('currentUserId');
            localStorage.removeItem('currentUserName');
            localStorage.removeItem('currentUserAvatar');
            setCurrentUserId(null);
            setCurrentUserName('');
            
            window.location.reload();
          }
        } catch (error) {
          console.error('Gre≈°ka:', error);
          alert('Gre≈°ka pri oslobaƒëanju punjaƒça.');
        }
      };

      const ChargerCard = ({ charger }) => {
        const [session, setSession] = useState(null);
        const [timeLeft, setTimeLeft] = useState('');

        useEffect(() => {
          const loadSession = async () => {
            const activeSession = await getActiveSession(charger.id);
            setSession(activeSession);
          };
          loadSession();

          const interval = setInterval(() => {
            loadSession();
          }, 5000);

          return () => clearInterval(interval);
        }, [charger.id]);

        useEffect(() => {
          if (session) {
            const updateTime = () => {
              const now = Date.now();
              const remaining = session.endTime - now;
              if (remaining > 0) {
                const minutes = Math.floor(remaining / 60000);
                setTimeLeft(`${minutes} min`);
              } else {
                setTimeLeft('Isteklo');
              }
            };
            updateTime();
            const interval = setInterval(updateTime, 1000);
            return () => clearInterval(interval);
          }
        }, [session]);

        const isOccupied = session && session.endTime > Date.now();

        return (
          <div className={`bg-white rounded-lg shadow-md p-6 border-2 ${isOccupied ? 'border-red-300' : 'border-green-300'}`}>
            <div className="flex justify-between items-start mb-4">
              <div>
                <h3 className="text-lg font-bold text-gray-800">{charger.name}</h3>
                <div className="flex items-center text-gray-600 text-sm mt-1">
                  <MapPin size={14} className="mr-1" />
                  {charger.location}
                </div>
              </div>
              <div className={`px-3 py-1 rounded-full text-sm font-semibold ${isOccupied ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                {isOccupied ? 'Zauzet' : 'Slobodan'}
              </div>
            </div>

            <div className="flex items-center gap-4 mb-4 text-sm text-gray-600">
              <div className="flex items-center">
                <Battery size={16} className="mr-1" />
                {charger.power}
              </div>
              <div className="px-2 py-1 bg-gray-100 rounded font-semibold">
                {charger.type}
              </div>
            </div>

            {isOccupied ? (
              <div className="bg-red-50 rounded-lg p-4 border border-red-200">
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center text-gray-700">
                    {session.avatar ? (
                      <img 
                        src={session.avatar} 
                        alt="Avatar" 
                        className="w-12 h-12 rounded-full object-cover mr-3 border-2 border-gray-300"
                      />
                    ) : (
                      <User size={28} className="mr-3 text-gray-400" />
                    )}
                    <div>
                      <div className="font-bold text-lg">{session.userName}</div>
                      <div className="text-sm text-gray-600">Punjaƒç zauzet</div>
                    </div>
                  </div>
                  <div className="flex flex-col items-end">
                    <div className="flex items-center text-red-600 font-bold text-xl">
                      <Clock size={20} className="mr-1" />
                      {timeLeft}
                    </div>
                    <div className="text-xs text-gray-500 mt-1">
                      Jo≈° {timeLeft}
                    </div>
                  </div>
                </div>
                {session.userId === currentUserId && (
                  <button
                    onClick={() => handleCheckOut(session)}
                    className="w-full mt-3 bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 transition-colors font-semibold text-lg"
                  >
                    ‚úì Oslobodi punjaƒç
                  </button>
                )}
              </div>
            ) : (
              <button
                onClick={() => {
                  setSelectedCharger(charger);
                  setShowCheckIn(true);
                }}
                className="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition-colors font-semibold"
              >
                Check-in
              </button>
            )}
          </div>
        );
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-green-50 p-4">
          {notification && (
            <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 z-50 ${
              notification.type === 'occupied' ? 'bg-red-500' : 'bg-green-500'
            } text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3 animate-bounce`}>
              <Bell size={24} />
              <span className="font-semibold">{notification.message}</span>
            </div>
          )}

          <div className="max-w-4xl mx-auto">
            <div className="text-center mb-8 mt-4">
              <div className="flex items-center justify-center mb-2">
                <Battery size={40} className="text-green-600 mr-2" />
                <h1 className="text-4xl font-bold text-gray-800">EV Punjaƒçi</h1>
              </div>
              <p className="text-gray-600">Proveri status i rezervi≈°i punjaƒç</p>
            </div>

            <div className="grid grid-cols-1 gap-6 mb-8 max-w-md mx-auto">
              {chargers.map(charger => (
                <ChargerCard key={charger.id} charger={charger} />
              ))}
            </div>

            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-gray-700 mb-6">
              <div className="flex items-start">
                <AlertCircle size={20} className="text-blue-600 mr-2 mt-0.5 flex-shrink-0" />
                <div>
                  <p className="font-semibold mb-1">Napomena:</p>
                  <p>Svi podaci su deljeni sa svim korisnicima aplikacije.</p>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-lg shadow-md border-2 border-blue-300 max-w-md mx-auto">
              <div 
                className="bg-blue-500 text-white p-4 rounded-t-lg cursor-pointer flex items-center justify-between"
                onClick={() => setShowChat(!showChat)}
              >
                <div className="flex items-center gap-2">
                  <span className="text-2xl">üí¨</span>
                  <h3 className="font-bold text-lg">Chat</h3>
                </div>
                <span className="text-xl">{showChat ? '‚ñº' : '‚ñ∂'}</span>
              </div>

              {showChat && (
                <div className="p-4">
                  <div className="bg-gray-50 rounded-lg p-3 mb-3 h-64 overflow-y-auto">
                    {messages.length === 0 ? (
                      <p className="text-gray-400 text-center py-8">Nema poruka</p>
                    ) : (
                      messages.map(msg => (
                        <div 
                          key={msg.id} 
                          className={`mb-3 flex ${msg.userId === currentUserId ? 'justify-end' : 'justify-start'}`}
                        >
                          <div className={`max-w-[80%] ${msg.userId === currentUserId ? 'bg-green-100' : 'bg-white'} rounded-lg p-3 shadow`}>
                            <div className="flex items-center gap-2 mb-1">
                              {msg.avatar && (
                                <img 
                                  src={msg.avatar} 
                                  alt="Avatar" 
                                  className="w-6 h-6 rounded-full object-cover"
                                />
                              )}
                              <span className="font-semibold text-sm">{msg.userName}</span>
                            </div>
                            <p className="text-gray-800">{msg.text}</p>
                            <p className="text-xs text-gray-400 mt-1">
                              {new Date(msg.timestamp).toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit' })}
                            </p>
                          </div>
                        </div>
                      ))
                    )}
                  </div>

                  <div className="flex gap-2">
                    <input
                      type="text"
                      value={newMessage}
                      onChange={(e) => setNewMessage(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                      placeholder="Napi≈°i poruku..."
                      className="flex-1 px-4 py-2 border border-gray-300 rounded-lg"
                      disabled={!currentUserName}
                    />
                    <button
                      onClick={sendMessage}
                      disabled={!newMessage.trim() || !currentUserName}
                      className="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 font-semibold disabled:bg-gray-300"
                    >
                      Po≈°alji
                    </button>
                  </div>
                  
                  {!currentUserName && (
                    <p className="text-xs text-red-500 mt-2 text-center">
                      Check-in-uj se prvo
                    </p>
                  )}
                </div>
              )}
            </div>
          </div>

          {showCheckIn && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 max-h-screen overflow-y-auto">
                <h2 className="text-2xl font-bold text-gray-800 mb-4">
                  Check-in na {selectedCharger?.name}
                </h2>
                
                <div className="mb-4">
                  <label className="block text-gray-700 font-semibold mb-2">
                    Tvoje ime:
                  </label>
                  <input
                    type="text"
                    value={userName}
                    onChange={(e) => setUserName(e.target.value)}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                    placeholder="Unesi ime..."
                  />
                </div>

                <div className="mb-4">
                  <label className="block text-gray-700 font-semibold mb-3">
                    Dodaj sliku:
                  </label>
                  <div className="flex items-center gap-4">
                    {avatarPreview ? (
                      <img 
                        src={avatarPreview} 
                        alt="Preview" 
                        className="w-20 h-20 rounded-full object-cover border-2 border-green-500"
                      />
                    ) : (
                      <div className="w-20 h-20 rounded-full bg-gray-200 flex items-center justify-center border-2 border-gray-300">
                        <User size={32} className="text-gray-400" />
                      </div>
                    )}
                    <div className="flex-1">
                      <input
                        type="file"
                        accept="image/*"
                        onChange={handleAvatarUpload}
                        className="hidden"
                        id="avatar-upload"
                      />
                      <label
                        htmlFor="avatar-upload"
                        className="cursor-pointer bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 font-semibold inline-block"
                      >
                        üì∑ Izaberi sliku
                      </label>
                    </div>
                  </div>
                </div>

                <div className="mb-6">
                  <label className="block text-gray-700 font-semibold mb-2">
                    Koliko dugo? (minuta)
                  </label>
                  <input
                    type="range"
                    min="15"
                    max="300"
                    step="15"
                    value={duration}
                    onChange={(e) => setDuration(Number(e.target.value))}
                    className="w-full"
                  />
                  <div className="text-center text-2xl font-bold text-green-600 mt-2">
                    {duration} minuta
                  </div>
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={() => {
                      setShowCheckIn(false);
                      setUserName('');
                      setDuration(30);
                      setSelectedAvatar(null);
                      setAvatarPreview(null);
                    }}
                    className="flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold"
                  >
                    Otka≈æi
                  </button>
                  <button
                    onClick={handleCheckIn}
                    disabled={!userName.trim() || !selectedAvatar}
                    className="flex-1 px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold disabled:bg-gray-300"
                  >
                    Potvrdi
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.render(<EVChargerApp />, document.getElementById('root'));
  </script>
</body>
</html>
