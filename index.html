<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#10b981">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>EV PunjaÄ Lidl</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš¡</text></svg>">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
</style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-green-50 min-h-screen p-4">

<div class="max-w-md mx-auto mt-8">
  <div class="text-center mb-8">
    <h1 class="text-4xl font-bold text-gray-800 mb-2">âš¡ EV PunjaÄi</h1>
    <p class="text-gray-600">Lidl KaluÄ‘erica</p>
    <div id="online-status" class="inline-block px-3 py-1 rounded-full text-xs font-semibold mt-2 bg-gray-200 text-gray-600">
      ğŸ”„ Povezivanje...
    </div>
  </div>

  <div id="charger-card" class="bg-white rounded-lg shadow-lg p-6 border-2 mb-6">
    <div class="flex justify-between items-start mb-4">
      <div>
        <h3 class="text-lg font-bold text-gray-800">EV PunjaÄ Lidl KaluÄ‘erica</h3>
        <p class="text-sm text-gray-600">ğŸ“ KaluÄ‘erica, Beograd</p>
        <p class="text-sm text-gray-600 mt-1">ğŸ”‹ 20kW DC</p>
      </div>
      <div id="status-badge" class="px-3 py-1 rounded-full text-sm font-semibold bg-gray-200 text-gray-600">
        UÄitava...
      </div>
    </div>

    <div id="occupied-view" class="hidden bg-red-50 rounded-lg p-4 border border-red-200">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-red-200 rounded-full flex items-center justify-center text-2xl mr-3">ğŸ‘¤</div>
          <div>
            <div id="user-name" class="font-bold text-lg"></div>
            <div class="text-sm text-gray-600">PunjaÄ zauzet</div>
          </div>
        </div>
        <div class="text-right">
          <div id="time-left" class="text-red-600 font-bold text-xl">â±ï¸</div>
          <div class="text-xs text-gray-500">preostalo</div>
        </div>
      </div>
      <button id="checkout-btn" class="w-full mt-3 bg-red-500 text-white py-3 rounded-lg font-semibold hover:bg-red-600 hidden">
        âœ“ Oslobodi punjaÄ
      </button>
    </div>

    <div id="free-view" class="hidden">
      <button id="checkin-btn" class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600">
        Check-in
      </button>
    </div>
  </div>

  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-gray-700">
    <p class="font-semibold mb-1">ğŸ’¡ Napomena:</p>
    <p>Svi korisnici vide isti status u realnom vremenu! ğŸŒ</p>
  </div>
</div>

<div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
  <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Check-in</h2>
    
    <div class="mb-4">
      <label class="block text-gray-700 font-semibold mb-2">Tvoje ime:</label>
      <input id="name-input" type="text" placeholder="Unesi ime..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
    </div>

    <div class="mb-6">
      <label class="block text-gray-700 font-semibold mb-2">Koliko dugo? (minuta)</label>
      <input id="duration-slider" type="range" min="15" max="300" step="15" value="30" class="w-full">
      <div id="duration-display" class="text-center text-2xl font-bold text-green-600 mt-2">30 min</div>
    </div>

    <div class="flex gap-3">
      <button id="cancel-btn" class="flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
        OtkaÅ¾i
      </button>
      <button id="confirm-btn" class="flex-1 px-4 py-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600">
        Potvrdi
      </button>
    </div>
  </div>
</div>

<div id="notification" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-6 py-4 rounded-lg shadow-2xl text-white font-semibold"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCg-60AsktOtXqj3BOXuIZLY-6dfamqcmo",
  authDomain: "ev-punjac-lidl.firebaseapp.com",
  databaseURL: "https://ev-punjac-lidl-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "ev-punjac-lidl",
  storageBucket: "ev-punjac-lidl.firebasestorage.app",
  messagingSenderId: "355937933260",
  appId: "1:355937933260:web:7939c0022a2103682f2f69"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const sessionRef = database.ref('charger_session');

let currentSession = null;
let duration = 30;

// GeneriÅ¡i JEDINSTVENI ID za ovaj browser/ureÄ‘aj koji se Äuva u sessionStorage
// sessionStorage radi i u Safari i u PWA i deli se izmeÄ‘u njih!
let deviceId = sessionStorage.getItem('deviceId');
if (!deviceId) {
  deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  sessionStorage.setItem('deviceId', deviceId);
}

const modal = document.getElementById('modal');
const chargerCard = document.getElementById('charger-card');
const statusBadge = document.getElementById('status-badge');
const occupiedView = document.getElementById('occupied-view');
const freeView = document.getElementById('free-view');
const checkinBtn = document.getElementById('checkin-btn');
const checkoutBtn = document.getElementById('checkout-btn');
const confirmBtn = document.getElementById('confirm-btn');
const cancelBtn = document.getElementById('cancel-btn');
const nameInput = document.getElementById('name-input');
const durationSlider = document.getElementById('duration-slider');
const durationDisplay = document.getElementById('duration-display');
const userName = document.getElementById('user-name');
const timeLeft = document.getElementById('time-left');
const onlineStatus = document.getElementById('online-status');
const notification = document.getElementById('notification');

function showNotification(message, isSuccess) {
  notification.textContent = message;
  notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-6 py-4 rounded-lg shadow-2xl text-white font-semibold ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
  notification.classList.remove('hidden');
  setTimeout(() => notification.classList.add('hidden'), 3000);
}

// SluÅ¡aj promene u Firebase-u
sessionRef.on('value', (snapshot) => {
  currentSession = snapshot.val();
  console.log('Session update:', currentSession);
  console.log('My device ID:', deviceId);
  updateUI();
  
  onlineStatus.textContent = 'âœ“ Online';
  onlineStatus.className = 'inline-block px-3 py-1 rounded-full text-xs font-semibold mt-2 bg-green-100 text-green-700';
});

// Proveri internet konekciju
database.ref('.info/connected').on('value', (snapshot) => {
  if (!snapshot.val()) {
    onlineStatus.textContent = 'âœ— Offline';
    onlineStatus.className = 'inline-block px-3 py-1 rounded-full text-xs font-semibold mt-2 bg-red-100 text-red-700';
  }
});

function updateUI() {
  if (currentSession && currentSession.endTime > Date.now()) {
    // PunjaÄ je zauzet
    chargerCard.classList.add('border-red-300');
    chargerCard.classList.remove('border-green-300');
    statusBadge.textContent = 'Zauzet';
    statusBadge.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-700';
    
    occupiedView.classList.remove('hidden');
    freeView.classList.add('hidden');
    
    userName.textContent = currentSession.name;
    
    // KLJUÄŒNA PROMENA: PoreÄ‘enje deviceId umesto userId
    console.log('Session deviceId:', currentSession.deviceId);
    console.log('My deviceId:', deviceId);
    console.log('Match:', currentSession.deviceId === deviceId);
    
    if (currentSession.deviceId === deviceId) {
      checkoutBtn.classList.remove('hidden');
      checkoutBtn.textContent = 'âœ“ Oslobodi punjaÄ (TI)';
    } else {
      checkoutBtn.classList.add('hidden');
    }
    
    updateTimeLeft();
  } else {
    // PunjaÄ je slobodan
    if (currentSession && currentSession.endTime <= Date.now()) {
      sessionRef.remove();
    }
    
    chargerCard.classList.add('border-green-300');
    chargerCard.classList.remove('border-red-300');
    statusBadge.textContent = 'Slobodan';
    statusBadge.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-700';
    
    occupiedView.classList.add('hidden');
    freeView.classList.remove('hidden');
  }
}

function updateTimeLeft() {
  if (!currentSession) return;
  
  const remaining = currentSession.endTime - Date.now();
  if (remaining > 0) {
    const minutes = Math.floor(remaining / 60000);
    timeLeft.textContent = `${minutes} min`;
  } else {
    timeLeft.textContent = 'Isteklo';
    sessionRef.remove();
  }
}

checkinBtn.addEventListener('click', () => {
  modal.classList.remove('hidden');
});

cancelBtn.addEventListener('click', () => {
  modal.classList.add('hidden');
  nameInput.value = '';
  duration = 30;
  durationSlider.value = 30;
  durationDisplay.textContent = '30 min';
});

durationSlider.addEventListener('input', (e) => {
  duration = parseInt(e.target.value);
  durationDisplay.textContent = `${duration} min`;
});

confirmBtn.addEventListener('click', () => {
  const name = nameInput.value.trim();
  
  if (!name) {
    showNotification('Unesi ime!', false);
    return;
  }
  
  const newSession = {
    deviceId: deviceId,  // ÄŒuvamo deviceId umesto userId
    name: name,
    startTime: Date.now(),
    endTime: Date.now() + (duration * 60 * 1000),
    duration: duration
  };
  
  console.log('Creating session with deviceId:', deviceId);
  
  sessionRef.set(newSession).then(() => {
    modal.classList.add('hidden');
    nameInput.value = '';
    duration = 30;
    durationSlider.value = 30;
    durationDisplay.textContent = '30 min';
    
    showNotification('âœ“ UspeÅ¡no rezervisano!', true);
  }).catch((error) => {
    console.error('GreÅ¡ka:', error);
    showNotification('GreÅ¡ka pri rezervaciji!', false);
  });
});

checkoutBtn.addEventListener('click', () => {
  if (confirm('OslobodiÅ¡ punjaÄ?')) {
    sessionRef.remove().then(() => {
      showNotification('âœ“ PunjaÄ osloboÄ‘en!', true);
    }).catch((error) => {
      console.error('GreÅ¡ka:', error);
      showNotification('GreÅ¡ka pri oslobaÄ‘anju!', false);
    });
  }
});

// AÅ¾uriraj vreme svake sekunde
setInterval(updateTimeLeft, 1000);
</script>


</body>
</html>
