<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#10b981">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>EV PunjaÄ Lidl</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš¡</text></svg>">
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
</style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-green-50 min-h-screen p-4">

<div class="max-w-md mx-auto mt-8">
  <!-- Header -->
  <div class="text-center mb-8">
    <h1 class="text-4xl font-bold text-gray-800 mb-2">âš¡ EV PunjaÄi</h1>
    <p class="text-gray-600">Lidl KaluÄ‘erica</p>
  </div>

  <!-- PunjaÄ Card -->
  <div id="charger-card" class="bg-white rounded-lg shadow-lg p-6 border-2 mb-6">
    <div class="flex justify-between items-start mb-4">
      <div>
        <h3 class="text-lg font-bold text-gray-800">EV PunjaÄ Lidl KaluÄ‘erica</h3>
        <p class="text-sm text-gray-600">ğŸ“ KaluÄ‘erica, Beograd</p>
        <p class="text-sm text-gray-600 mt-1">ğŸ”‹ 20kW DC</p>
      </div>
      <div id="status-badge" class="px-3 py-1 rounded-full text-sm font-semibold">
        UÄitava...
      </div>
    </div>

    <!-- Zauzet prikaz -->
    <div id="occupied-view" class="hidden bg-red-50 rounded-lg p-4 border border-red-200">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center">
          <img id="user-avatar" src="" class="w-12 h-12 rounded-full object-cover mr-3 border-2 border-gray-300 hidden">
          <div>
            <div id="user-name" class="font-bold text-lg"></div>
            <div class="text-sm text-gray-600">PunjaÄ zauzet</div>
          </div>
        </div>
        <div class="text-right">
          <div id="time-left" class="text-red-600 font-bold text-xl">â±ï¸</div>
          <div class="text-xs text-gray-500">preostalo</div>
        </div>
      </div>
      <button id="checkout-btn" class="w-full mt-3 bg-red-500 text-white py-3 rounded-lg font-semibold hover:bg-red-600 hidden">
        âœ“ Oslobodi punjaÄ
      </button>
    </div>

    <!-- Slobodan prikaz -->
    <div id="free-view" class="hidden">
      <button id="checkin-btn" class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600">
        Check-in
      </button>
    </div>
  </div>

  <!-- Napomena -->
  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-gray-700">
    <p class="font-semibold mb-1">ğŸ’¡ Napomena:</p>
    <p>Svi podaci su deljeni sa svim korisnicima aplikacije. Budi korektan!</p>
  </div>
</div>

<!-- Check-in Modal -->
<div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
  <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Check-in</h2>
    
    <div class="mb-4">
      <label class="block text-gray-700 font-semibold mb-2">Tvoje ime:</label>
      <input id="name-input" type="text" placeholder="Unesi ime..." class="w-full px-4 py-2 border border-gray-300 rounded-lg">
    </div>

    <div class="mb-4">
      <label class="block text-gray-700 font-semibold mb-3">Dodaj sliku:</label>
      <div class="flex items-center gap-4">
        <div id="preview-box" class="w-20 h-20 rounded-full bg-gray-200 flex items-center justify-center border-2 border-gray-300 overflow-hidden">
          <span class="text-gray-400 text-3xl">ğŸ‘¤</span>
        </div>
        <div>
          <input type="file" accept="image/*" id="file-input" class="hidden">
          <label for="file-input" class="cursor-pointer bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold inline-block hover:bg-blue-600">
            ğŸ“· Izaberi
          </label>
        </div>
      </div>
    </div>

    <div class="mb-6">
      <label class="block text-gray-700 font-semibold mb-2">Koliko dugo? (minuta)</label>
      <input id="duration-slider" type="range" min="15" max="300" step="15" value="30" class="w-full">
      <div id="duration-display" class="text-center text-2xl font-bold text-green-600 mt-2">30 min</div>
    </div>

    <div class="flex gap-3">
      <button id="cancel-btn" class="flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
        OtkaÅ¾i
      </button>
      <button id="confirm-btn" class="flex-1 px-4 py-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600">
        Potvrdi
      </button>
    </div>
  </div>
</div>

<!-- Notifikacija -->
<div id="notification" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-6 py-4 rounded-lg shadow-2xl text-white font-semibold">
  <span id="notif-text"></span>
</div>

<script>
// Globalne promenljive
let currentSession = null;
let currentUserId = localStorage.getItem('userId');
let selectedAvatar = null;
let duration = 30;

// UI elementi
const modal = document.getElementById('modal');
const chargerCard = document.getElementById('charger-card');
const statusBadge = document.getElementById('status-badge');
const occupiedView = document.getElementById('occupied-view');
const freeView = document.getElementById('free-view');
const checkinBtn = document.getElementById('checkin-btn');
const checkoutBtn = document.getElementById('checkout-btn');
const confirmBtn = document.getElementById('confirm-btn');
const cancelBtn = document.getElementById('cancel-btn');
const nameInput = document.getElementById('name-input');
const fileInput = document.getElementById('file-input');
const previewBox = document.getElementById('preview-box');
const durationSlider = document.getElementById('duration-slider');
const durationDisplay = document.getElementById('duration-display');
const userAvatar = document.getElementById('user-avatar');
const userName = document.getElementById('user-name');
const timeLeft = document.getElementById('time-left');

// Storage funkcije
async function getSession() {
  try {
    const result = await window.storage.get('lidl_session', true);
    return result ? JSON.parse(result.value) : null;
  } catch {
    return null;
  }
}

async function saveSession(session) {
  try {
    await window.storage.set('lidl_session', JSON.stringify(session), true);
    return true;
  } catch {
    return false;
  }
}

async function clearSession() {
  try {
    await window.storage.set('lidl_session', JSON.stringify(null), true);
    return true;
  } catch {
    return false;
  }
}

// Notifikacija
function showNotification(message, isSuccess) {
  const notif = document.getElementById('notification');
  const text = document.getElementById('notif-text');
  text.textContent = message;
  notif.className = `fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-6 py-4 rounded-lg shadow-2xl text-white font-semibold ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
  notif.classList.remove('hidden');
  setTimeout(() => notif.classList.add('hidden'), 3000);
}

// AÅ¾uriraj UI
async function updateUI() {
  currentSession = await getSession();
  
  if (currentSession && currentSession.endTime > Date.now()) {
    // PunjaÄ je zauzet
    chargerCard.classList.add('border-red-300');
    chargerCard.classList.remove('border-green-300');
    statusBadge.textContent = 'Zauzet';
    statusBadge.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-700';
    
    occupiedView.classList.remove('hidden');
    freeView.classList.add('hidden');
    
    userName.textContent = currentSession.name;
    
    if (currentSession.avatar) {
      userAvatar.src = currentSession.avatar;
      userAvatar.classList.remove('hidden');
    }
    
    // PrikaÅ¾i checkout dugme samo ako je trenutni korisnik
    if (currentSession.userId === currentUserId) {
      checkoutBtn.classList.remove('hidden');
    } else {
      checkoutBtn.classList.add('hidden');
    }
    
    updateTimeLeft();
  } else {
    // PunjaÄ je slobodan
    chargerCard.classList.add('border-green-300');
    chargerCard.classList.remove('border-red-300');
    statusBadge.textContent = 'Slobodan';
    statusBadge.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-700';
    
    occupiedView.classList.add('hidden');
    freeView.classList.remove('hidden');
  }
}

// AÅ¾uriraj preostalo vreme
function updateTimeLeft() {
  if (!currentSession) return;
  
  const remaining = currentSession.endTime - Date.now();
  if (remaining > 0) {
    const minutes = Math.floor(remaining / 60000);
    timeLeft.textContent = `${minutes} min`;
  } else {
    timeLeft.textContent = 'Isteklo';
    clearSession();
    updateUI();
  }
}

// Event listeners
checkinBtn.addEventListener('click', () => {
  modal.classList.remove('hidden');
});

cancelBtn.addEventListener('click', () => {
  modal.classList.add('hidden');
  nameInput.value = '';
  selectedAvatar = null;
  previewBox.innerHTML = '<span class="text-gray-400 text-3xl">ğŸ‘¤</span>';
});

fileInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file && file.type.startsWith('image/')) {
    const reader = new FileReader();
    reader.onload = (event) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const MAX_SIZE = 100;
        let width = img.width;
        let height = img.height;
        
        if (width > height) {
          if (width > MAX_SIZE) {
            height *= MAX_SIZE / width;
            width = MAX_SIZE;
          }
        } else {
          if (height > MAX_SIZE) {
            width *= MAX_SIZE / height;
            height = MAX_SIZE;
          }
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        selectedAvatar = canvas.toDataURL('image/jpeg', 0.6);
        previewBox.innerHTML = `<img src="${selectedAvatar}" class="w-full h-full object-cover">`;
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(file);
  }
});

durationSlider.addEventListener('input', (e) => {
  duration = parseInt(e.target.value);
  durationDisplay.textContent = `${duration} min`;
});

confirmBtn.addEventListener('click', async () => {
  const name = nameInput.value.trim();
  
  if (!name) {
    alert('Unesi ime!');
    return;
  }
  
  if (!selectedAvatar) {
    alert('Izaberi sliku!');
    return;
  }
  
  const userId = 'user_' + Date.now();
  const newSession = {
    userId: userId,
    name: name,
    avatar: selectedAvatar,
    startTime: Date.now(),
    endTime: Date.now() + (duration * 60 * 1000),
    duration: duration
  };
  
  const success = await saveSession(newSession);
  
  if (success) {
    localStorage.setItem('userId', userId);
    currentUserId = userId;
    modal.classList.add('hidden');
    nameInput.value = '';
    selectedAvatar = null;
    previewBox.innerHTML = '<span class="text-gray-400 text-3xl">ğŸ‘¤</span>';
    showNotification('âœ“ UspeÅ¡no rezervisano!', true);
    updateUI();
  } else {
    alert('GreÅ¡ka! PokuÅ¡aj ponovo.');
  }
});

checkoutBtn.addEventListener('click', async () => {
  if (confirm('OslobodiÅ¡ punjaÄ?')) {
    const success = await clearSession();
    if (success) {
      localStorage.removeItem('userId');
      currentUserId = null;
      showNotification('âœ“ PunjaÄ osloboÄ‘en!', true);
      updateUI();
    }
  }
});

// Inicijalizacija i auto-refresh
updateUI();
setInterval(updateUI, 5000);
setInterval(updateTimeLeft, 1000);
</script>

</body>
</html>
