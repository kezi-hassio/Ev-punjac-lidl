<script>
const firebaseConfig = {
  apiKey: "AIzaSyCg-60AsktOtXqj3BOXuIZLY-6dfamqcmo",
  authDomain: "ev-punjac-lidl.firebaseapp.com",
  databaseURL: "https://ev-punjac-lidl-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "ev-punjac-lidl",
  storageBucket: "ev-punjac-lidl.firebasestorage.app",
  messagingSenderId: "355937933260",
  appId: "1:355937933260:web:7939c0022a2103682f2f69"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const sessionRef = database.ref('charger_session');

let currentSession = null;
let duration = 30;

// Generiši jedinstveni ID uređaja
function getDeviceId() {
  let deviceId = localStorage.getItem('deviceId');
  
  if (!deviceId) {
    // Kreiraj jedinstveni ID baziran na različitim karakteristikama uređaja
    const fingerprint = [
      navigator.userAgent,
      navigator.language,
      screen.width + 'x' + screen.height,
      screen.colorDepth,
      new Date().getTimezoneOffset(),
      !!window.sessionStorage,
      !!window.localStorage
    ].join('|');
    
    // Hash fingerprint u jedinstveni ID
    let hash = 0;
    for (let i = 0; i < fingerprint.length; i++) {
      const char = fingerprint.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    
    deviceId = 'device_' + Math.abs(hash) + '_' + Date.now();
    localStorage.setItem('deviceId', deviceId);
  }
  
  return deviceId;
}

const myDeviceId = getDeviceId();
console.log('My Device ID:', myDeviceId);

const modal = document.getElementById('modal');
const pinModal = document.getElementById('pin-modal');
const pinInputModal = document.getElementById('pin-input-modal');
const chargerCard = document.getElementById('charger-card');
const statusBadge = document.getElementById('status-badge');
const occupiedView = document.getElementById('occupied-view');
const freeView = document.getElementById('free-view');
const checkinBtn = document.getElementById('checkin-btn');
const checkoutWithPinBtn = document.getElementById('checkout-with-pin-btn');
const confirmBtn = document.getElementById('confirm-btn');
const cancelBtn = document.getElementById('cancel-btn');
const pinOkBtn = document.getElementById('pin-ok-btn');
const pinCancelBtn = document.getElementById('pin-cancel-btn');
const pinConfirmBtn = document.getElementById('pin-confirm-btn');
const nameInput = document.getElementById('name-input');
const pinInput = document.getElementById('pin-input');
const pinDisplay = document.getElementById('pin-display');
const durationSlider = document.getElementById('duration-slider');
const durationDisplay = document.getElementById('duration-display');
const userName = document.getElementById('user-name');
const timeLeft = document.getElementById('time-left');
const onlineStatus = document.getElementById('online-status');
const notification = document.getElementById('notification');

function generatePin() {
  return Math.floor(1000 + Math.random() * 9000).toString();
}

function showNotification(message, isSuccess) {
  notification.textContent = message;
  notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-6 py-4 rounded-lg shadow-2xl text-white font-semibold ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
  notification.classList.remove('hidden');
  setTimeout(() => notification.classList.add('hidden'), 3000);
}

sessionRef.on('value', (snapshot) => {
  currentSession = snapshot.val();
  console.log('Session:', currentSession);
  updateUI();
  
  onlineStatus.textContent = '✓ Online';
  onlineStatus.className = 'inline-block px-3 py-1 rounded-full text-xs font-semibold mt-2 bg-green-100 text-green-700';
});

database.ref('.info/connected').on('value', (snapshot) => {
  if (!snapshot.val()) {
    onlineStatus.textContent = '✗ Offline';
    onlineStatus.className = 'inline-block px-3 py-1 rounded-full text-xs font-semibold mt-2 bg-red-100 text-red-700';
  }
});

function updateUI() {
  if (currentSession && currentSession.endTime <= Date.now()) {
    sessionRef.remove();
    currentSession = null;
  }
  
  if (currentSession && currentSession.endTime > Date.now()) {
    chargerCard.classList.add('border-red-300');
    chargerCard.classList.remove('border-green-300');
    statusBadge.textContent = 'Zauzet';
    statusBadge.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-700';
    
    occupiedView.classList.remove('hidden');
    freeView.classList.add('hidden');
    
    userName.textContent = currentSession.name;
    
    console.log('Session deviceId:', currentSession.deviceId);
    console.log('My deviceId:', myDeviceId);
    console.log('Match:', currentSession.deviceId === myDeviceId);
    
    // Proveri da li je ovo MOJ uređaj
    const isMyDevice = currentSession.deviceId === myDeviceId;
    
    // Ukloni stara dugmad
    const oldQuickBtn = document.getElementById('quick-release-btn');
    if (oldQuickBtn) oldQuickBtn.remove();
    
    if (isMyDevice) {
      // Kreiraj ZELENO dugme za direktno oslobađanje
      const quickReleaseBtn = document.createElement('button');
      quickReleaseBtn.id = 'quick-release-btn';
      quickReleaseBtn.className = 'w-full mt-3 bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600';
      quickReleaseBtn.textContent = '✓ Oslobodi punjač (MOJA REZERVACIJA)';
      quickReleaseBtn.onclick = () => {
        if (confirm('Oslobodiš punjač?')) {
          sessionRef.remove().then(() => {
            showNotification('✓ Punjač oslobođen!', true);
          });
        }
      };
      
      // Sakrij PIN dugme, prikaži zeleno dugme
      checkoutWithPinBtn.classList.add('hidden');
      occupiedView.querySelector('.space-y-2').appendChild(quickReleaseBtn);
    } else {
      // Prikaži PIN dugme za druge korisnike
      checkoutWithPinBtn.classList.remove('hidden');
    }
    
    updateTimeLeft();
  } else {
    chargerCard.classList.add('border-green-300');
    chargerCard.classList.remove('border-red-300');
    statusBadge.textContent = 'Slobodan';
    statusBadge.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-700';
    
    occupiedView.classList.add('hidden');
    freeView.classList.remove('hidden');
  }
}

function updateTimeLeft() {
  if (!currentSession) return;
  
  const remaining = currentSession.endTime - Date.now();
  
  if (remaining > 0) {
    const minutes = Math.floor(remaining / 60000);
    const seconds = Math.floor((remaining % 60000) / 1000);
    
    if (minutes > 0) {
      timeLeft.textContent = `${minutes} min`;
    } else {
      timeLeft.textContent = `${seconds} sek`;
    }
  } else {
    timeLeft.textContent = 'Oslobađam...';
    sessionRef.remove();
  }
}

checkinBtn.addEventListener('click', () => {
  modal.classList.remove('hidden');
});

cancelBtn.addEventListener('click', () => {
  modal.classList.add('hidden');
  nameInput.value = '';
  duration = 30;
  durationSlider.value = 30;
  durationDisplay.textContent = '30 min';
});

durationSlider.addEventListener('input', (e) => {
  duration = parseInt(e.target.value);
  durationDisplay.textContent = `${duration} min`;
});

confirmBtn.addEventListener('click', () => {
  const name = nameInput.value.trim();
  
  if (!name) {
    showNotification('Unesi ime!', false);
    return;
  }
  
  const pin = generatePin();
  
  const newSession = {
    deviceId: myDeviceId,  // Čuva se device ID
    pin: pin,  // I dalje ima PIN za alternativno oslobađanje
    name: name,
    startTime: Date.now(),
    endTime: Date.now() + (duration * 60 * 1000),
    duration: duration
  };
  
  console.log('Creating session with deviceId:', myDeviceId);
  
  sessionRef.set(newSession).then(() => {
    modal.classList.add('hidden');
    nameInput.value = '';
    duration = 30;
    durationSlider.value = 30;
    durationDisplay.textContent = '30 min';
    
    pinDisplay.textContent = pin;
    pinModal.classList.remove('hidden');
  }).catch((error) => {
    console.error('Greška:', error);
    showNotification('Greška pri rezervaciji!', false);
  });
});

pinOkBtn.addEventListener('click', () => {
  pinModal.classList.add('hidden');
  showNotification('✓ Uspešno rezervisano!', true);
});

checkoutWithPinBtn.addEventListener('click', () => {
  pinInputModal.classList.remove('hidden');
  pinInput.value = '';
  pinInput.focus();
});

pinCancelBtn.addEventListener('click', () => {
  pinInputModal.classList.add('hidden');
  pinInput.value = '';
});

pinConfirmBtn.addEventListener('click', () => {
  const enteredPin = pinInput.value.trim();
  
  if (!enteredPin) {
    showNotification('Unesi PIN kod!', false);
    return;
  }
  
  if (currentSession && currentSession.pin === enteredPin) {
    sessionRef.remove().then(() => {
      pinInputModal.classList.add('hidden');
      pinInput.value = '';
      showNotification('✓ Punjač oslobođen!', true);
    });
  } else {
    showNotification('✗ Pogrešan PIN kod!', false);
    pinInput.value = '';
  }
});

setInterval(updateTimeLeft, 1000);
</script>

